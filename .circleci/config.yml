version: 2
jobs:
  build:
    docker:
      - image: debian:stretch
    steps:
      - run:
          name: Set up environment variables
          command: |
            echo 'export MINICONDA=$HOME/miniconda' >> $BASH_ENV
            echo 'export PROJECT=$HOME/project' >> $BASH_ENV
            source $BASH_ENV
            echo 'test -d "$MINICONDA" && source $MINICONDA/etc/profile.d/conda.sh || echo "$MINICONDA does not exist"' >> $HOME/.bashrc
            env
            pwd
      - run:
          name: Update
          command: |
            apt-get update --assume-yes
            apt-get install --assume-yes wget git bzip2
      - checkout
      - run:
          name: Install miniconda
          command: |
            cd $HOME
            wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
            bash miniconda.sh -b -f -p $MINICONDA
            source $MINICONDA/etc/profile.d/conda.sh
            conda config --system --set always_yes yes
            conda update --quiet conda
            conda info -a
            conda env create --quiet -n umem-build --file=$PROJECT/.conda/environment.yml
      - run:
          name: Current working directory and listing
          command: |
            source $MINICONDA/etc/profile.d/conda.sh
            conda activate umem-build
            pwd
            echo "CONDA_PREFIX=$CONDA_PREFIX"
      - run:
          name: Building
          command: |
            source $MINICONDA/etc/profile.d/conda.sh
            conda activate umem-build
            mkdir build-umem-c
            cd build-umem-c
            cmake $PROJECT/c
            make -j 4
